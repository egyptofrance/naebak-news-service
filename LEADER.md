# 📰 LEADER - دليل خدمة الأخبار (الشريط الإخباري)

**اسم الخدمة:** naebak-news-service  
**المنفذ:** 8007  
**الإطار:** Flask 2.3  
**قاعدة البيانات:** SQLite (للبيانات البسيطة)  
**التخزين المؤقت:** Redis 6.2 (للأداء السريع)  

---

## 📋 **نظرة عامة على الخدمة**

### **🎯 الغرض الأساسي:**
خدمة الأخبار هي **شريط إخباري بسيط ومتحرك** يظهر تحت البنر الرئيسي مباشرة في جميع صفحات المنصة، يعرض الأخبار والإعلانات المهمة بشكل متحرك وجذاب.

### **📝 كيف يعمل التطبيق بالضبط:**

**للأدمن - إدارة الأخبار:**
1. الأدمن يدخل على **لوحة إدارة الأخبار** (جزء من خدمة الإدارة 8002)
2. يكتب **النص الإخباري** (حد أقصى 200 حرف)
3. يحدد **نوع الخبر:**
   - **أخبار عامة:** تظهر في جميع الصفحات (افتراضي)
   - **أخبار صفحة المرشحين:** تظهر فقط في صفحة تصفح المرشحين
   - **أخبار صفحة نائب محدد:** تظهر فقط في صفحة نائب معين
4. يحدد **إعدادات الحركة:**
   - **الاتجاه:** من اليسار لليمين أو من اليمين لليسار
   - **السرعة:** بطيء (30px/s) أو متوسط (50px/s) أو سريع (80px/s)
5. يحدد **فترة العرض:** تاريخ البداية والنهاية
6. يضغط **"نشر الخبر"** ليظهر فوراً في الشريط

**للزوار - مشاهدة الشريط الإخباري:**
1. الزائر يدخل على أي صفحة في المنصة
2. **تلقائياً** يظهر الشريط الإخباري تحت البنر الرئيسي مباشرة
3. يرى **النصوص تتحرك** حسب الاتجاه والسرعة المحددة
4. **الأخبار المعروضة** تعتمد على الصفحة:
   - **صفحة الهبوط:** أخبار عامة + أخبار خاصة بالصفحة (إن وجدت)
   - **صفحة تصفح المرشحين:** أخبار المرشحين + أخبار عامة (إن لم توجد أخبار خاصة)
   - **صفحة نائب محدد:** أخبار النائب + أخبار عامة (إن لم توجد أخبار خاصة)

**مثال عملي:**
- الأدمن يضع خبر عام: "مرحباً بكم في منصة نائبك الجديدة"
- يضع خبر خاص بصفحة المرشحين: "تصفح جميع المرشحين واختر الأنسب لمحافظتك"
- **النتيجة:** 
  - في الصفحة الرئيسية: يظهر الخبر العام
  - في صفحة المرشحين: يظهر الخبر الخاص بالمرشحين

### **🎨 مواصفات التصميم الدقيقة:**

**هيكل الشريط الإخباري:**
```
┌─────────────────────────────────────────────────────────────┐
│ شريط برتقالي (2px)                                          │ ← أعلى الشريط
├─────────────────────────────────────────────────────────────┤
│ الخلفية الرمادية الغامقة + النص الأبيض المتحرك                │ ← الشريط الرئيسي
├─────────────────────────────────────────────────────────────┤
│ شريط برتقالي (4px)                                          │ ← أسفل الشريط
├─────────────────────────────────────────────────────────────┤
│ شريط رمادي غامق (2px)                                       │ ← الحد السفلي
└─────────────────────────────────────────────────────────────┘
```

**الألوان المحددة:**
- **الخلفية الرئيسية:** #2D2D2D (رمادي غامق)
- **النص:** #FFFFFF (أبيض)
- **الشريط البرتقالي العلوي:** #FF6B35 (2px)
- **الشريط البرتقالي السفلي:** #FF6B35 (4px)
- **الحد السفلي:** #2D2D2D (رمادي غامق 2px)

**المواضع:**
- **الموضع:** تحت البنر الرئيسي مباشرة
- **العرض:** 100% من عرض الصفحة
- **الارتفاع الإجمالي:** 38px (2+30+4+2)

---

## 🌐 **دور الخدمة في منصة نائبك**

### **🏛️ المكانة في النظام:**
خدمة الأخبار تعمل كنظام إعلامي مركزي يوفر المعلومات الحيوية والأخبار المهمة لجميع زوار المنصة.

### **📡 العلاقات مع الخدمات الأخرى:**

#### **🔗 الخدمات المباشرة:**
- **خدمة الإدارة (8002)** - لإدارة الأخبار وإعداداتها
- **خدمة البنرات (8009)** - للتنسيق في المواضع (تحت البنر مباشرة)
- **خدمة الإحصائيات (8012)** - لإرسال بيانات المشاهدات
- **خدمة البوابة (8013)** - لتوجيه الطلبات

#### **🔄 الخدمات المساعدة:**
- **خدمة المصادقة (8001)** - للتحقق من صلاحيات الأدمن
- **خدمة المحتوى (8010)** - للتكامل مع المحتوى العام

---

## 📊 **البيانات الأساسية من مستودع المخزن**

### **🗂️ أنواع الأخبار:**
```python
NEWS_TYPES = {
    "general": {
        "name": "أخبار عامة",
        "description": "تظهر في جميع صفحات المنصة",
        "priority": 1,
        "icon": "📢"
    },
    "candidates": {
        "name": "أخبار المرشحين", 
        "description": "تظهر في صفحة تصفح المرشحين",
        "priority": 2,
        "icon": "🗳️"
    },
    "representative": {
        "name": "أخبار نائب محدد",
        "description": "تظهر في صفحة نائب معين",
        "priority": 3,
        "icon": "👤"
    },
    "urgent": {
        "name": "أخبار عاجلة",
        "description": "تظهر في جميع الصفحات بأولوية عالية",
        "priority": 0,
        "icon": "🚨"
    }
}
```

### **⚙️ إعدادات الحركة:**
```python
SCROLL_DIRECTIONS = {
    "ltr": {
        "name": "من اليسار لليمين",
        "css_direction": "normal",
        "default": True
    },
    "rtl": {
        "name": "من اليمين لليسار", 
        "css_direction": "reverse",
        "default": False
    }
}

SCROLL_SPEEDS = {
    "slow": {
        "name": "بطيء",
        "pixels_per_second": 30,
        "duration_multiplier": 1.5
    },
    "medium": {
        "name": "متوسط",
        "pixels_per_second": 50,
        "duration_multiplier": 1.0,
        "default": True
    },
    "fast": {
        "name": "سريع",
        "pixels_per_second": 80,
        "duration_multiplier": 0.7
    }
}
```

### **🎨 مواصفات التصميم:**
```python
DESIGN_SPECS = {
    "colors": {
        "background": "#2D2D2D",
        "text": "#FFFFFF", 
        "orange_top": "#FF6B35",
        "orange_bottom": "#FF6B35",
        "border_bottom": "#2D2D2D"
    },
    "dimensions": {
        "total_height": "38px",
        "top_border": "2px",
        "main_content": "30px", 
        "bottom_border": "4px",
        "final_border": "2px",
        "width": "100%"
    },
    "fonts": {
        "family": "Cairo, Arial, sans-serif",
        "size": "14px",
        "weight": "500",
        "line_height": "30px"
    }
}
```

### **📍 مواضع العرض:**
```python
PAGE_POSITIONS = {
    "home": {
        "name": "الصفحة الرئيسية",
        "news_types": ["urgent", "general"],
        "fallback": "general"
    },
    "candidates": {
        "name": "صفحة تصفح المرشحين",
        "news_types": ["urgent", "candidates", "general"],
        "fallback": "general"
    },
    "representative": {
        "name": "صفحة النائب",
        "news_types": ["urgent", "representative", "general"],
        "fallback": "general"
    },
    "complaints": {
        "name": "صفحة الشكاوى",
        "news_types": ["urgent", "general"],
        "fallback": "general"
    }
}
```

---

## ⚙️ **إعدادات Google Cloud Run**

### **🔧 بيئة التطوير:**
```yaml
Environment: development
Port: 8007
Database: SQLite (local file)
Redis: localhost:6379
Resources:
  CPU: 0.1
  Memory: 64Mi
  Max Instances: 1
  Min Instances: 1

Environment Variables:
  FLASK_ENV=development
  DATABASE_URL=sqlite:///news.db
  REDIS_URL=redis://localhost:6379/7
  NEWS_CACHE_TTL=60
  MAX_NEWS_LENGTH=200
  SCROLL_SPEED=50
  AUTO_REFRESH_SECONDS=10
  DEBUG=True
```

### **🚀 بيئة الإنتاج:**
```yaml
Environment: production
Port: 8007
Database: SQLite (persistent volume)
Redis: Cloud Memorystore
Resources:
  CPU: 0.1
  Memory: 64Mi
  Max Instances: 3
  Min Instances: 1

Environment Variables:
  FLASK_ENV=production
  DATABASE_URL=sqlite:///data/news.db
  REDIS_URL=${REDIS_CONNECTION_STRING}
  NEWS_CACHE_TTL=300
  MAX_NEWS_LENGTH=200
  SCROLL_SPEED=50
  AUTO_REFRESH_SECONDS=30
  DEBUG=False
  
Security:
  - HTTPS only
  - CORS enabled for naebak.com
  - Rate limiting: 100 requests/minute
```

### **🧪 بيئة الاختبار:**
```yaml
Environment: testing
Port: 8007
Database: SQLite (in-memory)
Redis: Redis (in-memory)
Resources:
  CPU: 0.1
  Memory: 32Mi
  Max Instances: 1
  Min Instances: 1

Environment Variables:
  FLASK_ENV=testing
  DATABASE_URL=sqlite:///:memory:
  REDIS_URL=redis://localhost:6379/15
  NEWS_CACHE_TTL=10
  MAX_NEWS_LENGTH=100
  SCROLL_SPEED=100
  AUTO_REFRESH_SECONDS=5
  DEBUG=True
```

---

## 🔐 **الأمان والصلاحيات**

### **👥 مستويات الوصول:**

#### **🔴 مستوى الإدارة العليا:**
- **إنشاء وتعديل وحذف** جميع الأخبار
- **تغيير إعدادات الحركة** (الاتجاه والسرعة)
- **إدارة الأخبار العاجلة** والأولويات
- **عرض إحصائيات مفصلة** للمشاهدات

#### **🟡 مستوى المحرر:**
- **إنشاء وتعديل** الأخبار العامة فقط
- **عرض إحصائيات أساسية**
- **لا يمكن حذف** الأخبار الموجودة

#### **🟢 مستوى القراءة:**
- **عرض الأخبار** فقط
- **لا يمكن التعديل** أو الإضافة

### **🛡️ آليات الحماية:**
1. **تنظيف HTML** - إزالة الأكواد الضارة من النصوص
2. **تحديد طول النص** - حد أقصى 200 حرف
3. **Rate Limiting** - 100 طلب في الدقيقة لكل IP
4. **مصادقة مطلوبة** - للعمليات الإدارية
5. **تشفير HTTPS** - جميع الاتصالات مشفرة
6. **تسجيل العمليات** - تتبع جميع التغييرات

---

## 📡 **واجهات برمجة التطبيقات (APIs)**

### **📰 إدارة الأخبار:**

#### **1. إنشاء خبر جديد**
```http
POST /api/news/create/
Content-Type: application/json
Authorization: Bearer {admin_token}

{
    "text": "مرحباً بكم في منصة نائبك الجديدة",
    "type": "general",
    "page_specific": null,
    "direction": "ltr",
    "speed": "medium",
    "start_date": "2024-01-01T00:00:00Z",
    "end_date": "2024-12-31T23:59:59Z",
    "is_active": true
}
```

**الاستجابة:**
```json
{
    "success": true,
    "message": "تم إنشاء الخبر بنجاح",
    "data": {
        "id": 1,
        "text": "مرحباً بكم في منصة نائبك الجديدة",
        "type": "general",
        "direction": "ltr",
        "speed": "medium",
        "is_active": true,
        "created_at": "2024-01-01T10:00:00Z"
    }
}
```

#### **2. الحصول على أخبار صفحة محددة**
```http
GET /api/news/page/{page_name}/
```

**الاستجابة:**
```json
{
    "success": true,
    "data": {
        "page": "home",
        "news": [
            {
                "id": 1,
                "text": "مرحباً بكم في منصة نائبك الجديدة",
                "direction": "ltr",
                "speed": "medium",
                "type": "general"
            }
        ],
        "settings": {
            "auto_refresh": 30,
            "cache_duration": 300
        }
    }
}
```

#### **3. تحديث إعدادات الحركة**
```http
PUT /api/news/settings/
Content-Type: application/json
Authorization: Bearer {admin_token}

{
    "default_direction": "ltr",
    "default_speed": "medium",
    "auto_refresh_seconds": 30
}
```

#### **4. حذف خبر**
```http
DELETE /api/news/{news_id}/
Authorization: Bearer {admin_token}
```

#### **5. إحصائيات الأخبار**
```http
GET /api/news/statistics/
Authorization: Bearer {admin_token}
```

**الاستجابة:**
```json
{
    "success": true,
    "data": {
        "total_news": 15,
        "active_news": 8,
        "views_today": 1247,
        "most_viewed": {
            "id": 3,
            "text": "انتخابات مجلس النواب 2024",
            "views": 892
        },
        "by_type": {
            "general": 5,
            "candidates": 2,
            "representative": 1
        }
    }
}
```

### **🔧 APIs المساعدة:**

#### **6. الحصول على أنواع الأخبار**
```http
GET /api/news/types/
```

#### **7. الحصول على إعدادات السرعة**
```http
GET /api/news/speeds/
```

#### **8. فحص صحة الخدمة**
```http
GET /health
```

---

## 🔄 **الفروق بين البيئات**

| **الخاصية** | **التطوير** | **الإنتاج** | **الاختبار** |
|-------------|-------------|-------------|-------------|
| **قاعدة البيانات** | SQLite محلي | SQLite مستمر | في الذاكرة |
| **Redis** | محلي | Cloud Memorystore | محلي |
| **Cache TTL** | 60 ثانية | 300 ثانية | 10 ثواني |
| **التحديث التلقائي** | 10 ثواني | 30 ثانية | 5 ثواني |
| **حد النص** | 200 حرف | 200 حرف | 100 حرف |
| **Rate Limiting** | معطل | 100/دقيقة | معطل |
| **التسجيل** | مفصل | أساسي | مفصل |
| **الموارد** | 64Mi | 64Mi | 32Mi |

---

## 📊 **المراقبة والتحليلات**

### **📈 مقاييس الأداء:**
1. **عدد المشاهدات** - إجمالي مشاهدات الشريط
2. **وقت المشاهدة** - متوسط وقت بقاء النص على الشاشة
3. **معدل التحديث** - تكرار تحديث المحتوى
4. **استخدام الذاكرة** - استهلاك Redis والتخزين المؤقت
5. **أوقات الاستجابة** - سرعة تحميل الأخبار
6. **معدل الأخطاء** - نسبة الطلبات الفاشلة

### **🚨 التنبيهات:**
- **تحميل بطيء** - إذا تجاوز وقت الاستجابة 500ms
- **ذاكرة ممتلئة** - إذا تجاوز استخدام الذاكرة 80%
- **أخطاء متكررة** - إذا تجاوزت نسبة الأخطاء 5%
- **انقطاع الخدمة** - إذا لم تستجب الخدمة لأكثر من دقيقة

---

## 🛠️ **خطة التطوير**

### **المرحلة الأولى (1 أسبوع):**
- إعداد Flask والقاعدة الأساسية
- تطوير APIs الأساسية (إنشاء، عرض، تحديث، حذف)
- تطبيق مواصفات التصميم الدقيقة
- ربط مع Redis للتخزين المؤقت

### **المرحلة الثانية (1 أسبوع):**
- تطوير لوحة الأدمن للإدارة
- تطبيق إعدادات الحركة (الاتجاه والسرعة)
- ربط مع خدمة المصادقة
- تطبيق الأمان والصلاحيات

### **المرحلة الثالثة (1 أسبوع):**
- ربط مع خدمة الإحصائيات
- تطبيق المراقبة والتنبيهات
- اختبارات شاملة ونشر
- تحسين الأداء والتخزين المؤقت

---

## 📚 **الموارد والمراجع**

### **🔧 التبعيات:**
```python
DEPENDENCIES = [
    "Flask==2.3.3",
    "Flask-SQLAlchemy==3.1.1", 
    "redis==5.0.1",
    "bleach==6.1.0",  # لتنظيف HTML
    "APScheduler==3.10.4"  # للمهام المجدولة
]
```

### **🔗 الروابط المهمة:**
- **مستودع المخزن:** `/naebak-almakhzan/`
- **خدمة الإدارة:** `naebak-admin-service:8002`
- **خدمة الإحصائيات:** `naebak-statistics-service:8012`
- **وثائق Flask:** https://flask.palletsprojects.com/
- **وثائق Redis:** https://redis.io/documentation

---

## 🎯 **الخلاصة**

خدمة الأخبار هي **شريط إخباري بسيط وفعال** يوفر المعلومات الحيوية لزوار المنصة بشكل جذاب ومتحرك. الخدمة تركز على **البساطة والأداء** مع تحكم كامل في المحتوى والتصميم.

**النقاط الرئيسية:**
- ✅ شريط إخباري متحرك بتصميم محدد دقيقاً
- ✅ تحكم كامل في الاتجاه والسرعة
- ✅ أخبار مخصصة لكل صفحة مع أخبار عامة احتياطية
- ✅ إدارة سهلة من لوحة الأدمن
- ✅ أداء سريع مع Redis والتخزين المؤقت
- ✅ تكامل سلس مع باقي خدمات المنصة

الخدمة الآن **جاهزة للتطوير** مع جميع المتطلبات والمواصفات محددة بوضوح.
